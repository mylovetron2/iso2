<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MÃ´ táº£ Logic Thá»‘ng kÃª Kiá»ƒm Ä‘á»‹nh</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h2 {
            color: #1e40af;
            margin-top: 30px;
            margin-bottom: 15px;
            border-left: 4px solid #3b82f6;
            padding-left: 15px;
        }
        h3 {
            color: #1d4ed8;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
        }
        .highlight {
            background: #fef3c7;
            padding: 15px;
            border-left: 4px solid #f59e0b;
            margin: 15px 0;
            border-radius: 4px;
        }
        .info-box {
            background: #dbeafe;
            padding: 15px;
            border-left: 4px solid #3b82f6;
            margin: 15px 0;
            border-radius: 4px;
        }
        .success-box {
            background: #d1fae5;
            padding: 15px;
            border-left: 4px solid #10b981;
            margin: 15px 0;
            border-radius: 4px;
        }
        .warning-box {
            background: #fee2e2;
            padding: 15px;
            border-left: 4px solid #ef4444;
            margin: 15px 0;
            border-radius: 4px;
        }
        code {
            background: #1e293b;
            color: #e2e8f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            line-height: 1.5;
        }
        pre code {
            background: none;
            padding: 0;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            margin: 5px;
            font-size: 0.9em;
        }
        .status-chua {
            background: #fee2e2;
            color: #991b1b;
        }
        .status-dung {
            background: #d1fae5;
            color: #065f46;
        }
        .status-truoc {
            background: #fef3c7;
            color: #92400e;
        }
        .status-sau {
            background: #fed7aa;
            color: #9a3412;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #cbd5e1;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #2563eb;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background: #f8fafc;
        }
        .flowchart {
            background: white;
            border: 2px solid #3b82f6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
        }
        ul, ol {
            margin: 10px 0;
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        .formula {
            background: #fef3c7;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š MÃ´ táº£ Logic Thá»‘ng kÃª Kiá»ƒm Ä‘á»‹nh (thongke_kiemdinh.php)</h1>

        <div class="info-box">
            <strong>ğŸ¯ Má»¥c Ä‘Ã­ch:</strong> Module thá»‘ng kÃª Ä‘Ã¡nh giÃ¡ viá»‡c thá»±c hiá»‡n kiá»ƒm Ä‘á»‹nh thiáº¿t bá»‹ so vá»›i káº¿ hoáº¡ch Ä‘Ã£ Ä‘á» ra, 
            phÃ¢n loáº¡i theo tráº¡ng thÃ¡i: Ä‘Ãºng háº¡n, trÆ°á»›c háº¡n, sau háº¡n, chÆ°a kiá»ƒm Ä‘á»‹nh.
        </div>

        <h2>ğŸ“‹ I. Cáº¥u trÃºc dá»¯ liá»‡u</h2>

        <div class="section">
            <h3>Báº£ng chÃ­nh:</h3>
            <table>
                <thead>
                    <tr>
                        <th>Báº£ng</th>
                        <th>MÃ´ táº£</th>
                        <th>Cá»™t quan trá»ng</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>kehoach_iso</code></td>
                        <td>Káº¿ hoáº¡ch kiá»ƒm Ä‘á»‹nh</td>
                        <td><code>somay</code>, <code>mahieu</code>, <code>thang</code>, <code>namkh</code></td>
                    </tr>
                    <tr>
                        <td><code>hosohckd_iso</code></td>
                        <td>Há»“ sÆ¡ hiá»‡u chuáº©n kiá»ƒm Ä‘á»‹nh thá»±c táº¿</td>
                        <td><code>tenmay</code>, <code>ngayhc</code>, <code>namkh</code></td>
                    </tr>
                </tbody>
            </table>

            <div class="highlight">
                <strong>ğŸ”‘ Mapping Key:</strong><br>
                <code>kehoach_iso.mahieu = hosohckd_iso.tenmay</code>
            </div>
        </div>

        <h2>âš™ï¸ II. Quy trÃ¬nh xá»­ lÃ½</h2>

        <div class="flowchart">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Load kehoach_iso (káº¿ hoáº¡ch nÄƒm)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Load hosohckd_iso (há»“ sÆ¡ thá»±c táº¿ nÄƒm)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Äáº¿m planCount cho má»—i thiáº¿t bá»‹           â”‚
â”‚    (sá»‘ láº§n xuáº¥t hiá»‡n trong káº¿ hoáº¡ch)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Vá»›i má»—i plan:                            â”‚
â”‚    a. TÃ­nh khoáº£ng thá»i gian cho phÃ©p        â”‚
â”‚    b. TÃ¬m inspection record matching        â”‚
â”‚    c. So sÃ¡nh ngayhc vá»›i khoáº£ng cho phÃ©p    â”‚
â”‚    d. PhÃ¢n loáº¡i vÃ o 1 trong 4 tráº¡ng thÃ¡i    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. TÃ­nh summary statistics                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        </div>

        <h2>ğŸ“… III. TÃ­nh toÃ¡n khoáº£ng thá»i gian cho phÃ©p</h2>

        <div class="section">
            <h3>TrÆ°á»ng há»£p A: Thiáº¿t bá»‹ cÃ³ 1 láº§n kiá»ƒm Ä‘á»‹nh/nÄƒm (planCount = 1)</h3>
            <div class="info-box">
                <strong>Quy táº¯c:</strong> Cho phÃ©p kiá»ƒm Ä‘á»‹nh trong <strong>3 thÃ¡ng liÃªn tiáº¿p</strong><br>
                <ul>
                    <li>ThÃ¡ng báº¯t Ä‘áº§u: <code>max(1, thang - 2)</code></li>
                    <li>ThÃ¡ng káº¿t thÃºc: <code>thang</code></li>
                    <li>NgÃ y báº¯t Ä‘áº§u: NgÃ y Ä‘áº§u tiÃªn cá»§a thÃ¡ng báº¯t Ä‘áº§u</li>
                    <li>NgÃ y káº¿t thÃºc: NgÃ y cuá»‘i cÃ¹ng cá»§a thÃ¡ng káº¿ hoáº¡ch</li>
                </ul>
                <strong>VÃ­ dá»¥:</strong><br>
                Káº¿ hoáº¡ch: ThÃ¡ng 6/2025<br>
                â†’ Cho phÃ©p: <strong>01/04/2025</strong> Ä‘áº¿n <strong>30/06/2025</strong>
            </div>

            <h3>TrÆ°á»ng há»£p B: Thiáº¿t bá»‹ cÃ³ nhiá»u láº§n kiá»ƒm Ä‘á»‹nh/nÄƒm (planCount > 1)</h3>
            <div class="info-box">
                <strong>Quy táº¯c:</strong> Cho phÃ©p kiá»ƒm Ä‘á»‹nh trong khoáº£ng <strong>Â±15 ngÃ y</strong> xung quanh ngÃ y 15 cá»§a thÃ¡ng káº¿ hoáº¡ch<br>
                <ul>
                    <li>NgÃ y trung tÃ¢m: NgÃ y 15 cá»§a thÃ¡ng káº¿ hoáº¡ch</li>
                    <li>NgÃ y báº¯t Ä‘áº§u: NgÃ y trung tÃ¢m - 15 ngÃ y</li>
                    <li>NgÃ y káº¿t thÃºc: NgÃ y trung tÃ¢m + 15 ngÃ y</li>
                </ul>
                <strong>VÃ­ dá»¥:</strong><br>
                Káº¿ hoáº¡ch: ThÃ¡ng 6/2025<br>
                â†’ Cho phÃ©p: <strong>31/05/2025</strong> Ä‘áº¿n <strong>30/06/2025</strong>
            </div>
        </div>

        <h2>ğŸ·ï¸ IV. PhÃ¢n loáº¡i tráº¡ng thÃ¡i kiá»ƒm Ä‘á»‹nh</h2>

        <div class="section">
            <h3>4 tráº¡ng thÃ¡i:</h3>

            <div class="warning-box">
                <span class="status-badge status-chua">1. CHÆ¯A KIá»‚M Äá»ŠNH</span><br>
                <strong>Äiá»u kiá»‡n:</strong>
                <ul>
                    <li>KHÃ”NG tÃ¬m tháº¥y record trong <code>hosohckd_iso</code> match vá»›i <code>mahieu</code> vÃ  <code>namkh</code></li>
                    <li>HOáº¶C cÃ³ record nhÆ°ng <code>ngayhc IS NULL</code></li>
                </ul>
                <strong>Code:</strong> <code>chua_kiem_dinh</code>
            </div>

            <div class="success-box">
                <span class="status-badge status-dung">2. ÄÃšNG Káº¾ HOáº CH</span><br>
                <strong>Äiá»u kiá»‡n:</strong>
                <ul>
                    <li>CÃ³ record trong <code>hosohckd_iso</code></li>
                    <li><code>startDate â‰¤ ngayhc â‰¤ endDate</code></li>
                </ul>
                <strong>Code:</strong> <code>dung_ke_hoach</code>
            </div>

            <div class="highlight">
                <span class="status-badge status-truoc">3. TRÆ¯á»šC Háº N</span><br>
                <strong>Äiá»u kiá»‡n:</strong>
                <ul>
                    <li>CÃ³ record trong <code>hosohckd_iso</code></li>
                    <li><code>ngayhc < startDate</code></li>
                </ul>
                <strong>Code:</strong> <code>truoc_han</code>
            </div>

            <div class="warning-box">
                <span class="status-badge status-sau">4. SAU Háº N</span><br>
                <strong>Äiá»u kiá»‡n:</strong>
                <ul>
                    <li>CÃ³ record trong <code>hosohckd_iso</code></li>
                    <li><code>ngayhc > endDate</code></li>
                </ul>
                <strong>Code:</strong> <code>sau_han</code>
            </div>
        </div>

        <h2>ğŸ“ˆ V. Summary Statistics</h2>

        <div class="section">
            <table>
                <thead>
                    <tr>
                        <th>TÃªn thá»‘ng kÃª</th>
                        <th>MÃ´ táº£</th>
                        <th>CÃ´ng thá»©c</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>total_plans</code></td>
                        <td>Tá»•ng sá»‘ káº¿ hoáº¡ch</td>
                        <td><code>COUNT(*) FROM kehoach_iso WHERE namkh = ?</code></td>
                    </tr>
                    <tr>
                        <td><code>dung_ke_hoach</code></td>
                        <td>Sá»‘ lÆ°á»£ng kiá»ƒm Ä‘á»‹nh Ä‘Ãºng háº¡n</td>
                        <td>Äáº¿m sá»‘ status = <code>'dung_ke_hoach'</code></td>
                    </tr>
                    <tr>
                        <td><code>chua_kiem_dinh</code></td>
                        <td>Sá»‘ lÆ°á»£ng chÆ°a kiá»ƒm Ä‘á»‹nh</td>
                        <td>Äáº¿m sá»‘ status = <code>'chua_kiem_dinh'</code></td>
                    </tr>
                    <tr>
                        <td><code>truoc_han</code></td>
                        <td>Sá»‘ lÆ°á»£ng kiá»ƒm Ä‘á»‹nh trÆ°á»›c háº¡n</td>
                        <td>Äáº¿m sá»‘ status = <code>'truoc_han'</code></td>
                    </tr>
                    <tr>
                        <td><code>sau_han</code></td>
                        <td>Sá»‘ lÆ°á»£ng kiá»ƒm Ä‘á»‹nh sau háº¡n</td>
                        <td>Äáº¿m sá»‘ status = <code>'sau_han'</code></td>
                    </tr>
                    <tr>
                        <td><code>tyle_hoan_thanh</code></td>
                        <td>Tá»· lá»‡ hoÃ n thÃ nh (%)</td>
                        <td><code>(dung + truoc + sau) / total * 100</code></td>
                    </tr>
                </tbody>
            </table>

            <div class="formula">
                Tá»· lá»‡ hoÃ n thÃ nh = (ÄÃ£ kiá»ƒm Ä‘á»‹nh / Tá»•ng káº¿ hoáº¡ch) Ã— 100%
            </div>
        </div>

        <h2>ğŸ’¡ VI. VÃ­ dá»¥ minh há»a</h2>

        <div class="section">
            <h3>VÃ­ dá»¥ 1: Thiáº¿t bá»‹ kiá»ƒm Ä‘á»‹nh 1 láº§n/nÄƒm</h3>
            <pre><code>Káº¿ hoáº¡ch: MÃ¡y A - ThÃ¡ng 8/2025
Plan Count: 1
Khoáº£ng cho phÃ©p: 01/06/2025 â†’ 31/08/2025

Ká»‹ch báº£n:
- NgÃ y kiá»ƒm Ä‘á»‹nh: 15/05/2025 â†’ <span style="color: #f59e0b;">TRÆ¯á»šC Háº N</span>
- NgÃ y kiá»ƒm Ä‘á»‹nh: 20/07/2025 â†’ <span style="color: #10b981;">ÄÃšNG Káº¾ HOáº CH</span>
- NgÃ y kiá»ƒm Ä‘á»‹nh: 10/09/2025 â†’ <span style="color: #f97316;">SAU Háº N</span>
- KhÃ´ng cÃ³ record          â†’ <span style="color: #ef4444;">CHÆ¯A KIá»‚M Äá»ŠNH</span></code></pre>

            <h3>VÃ­ dá»¥ 2: Thiáº¿t bá»‹ kiá»ƒm Ä‘á»‹nh nhiá»u láº§n/nÄƒm</h3>
            <pre><code>Káº¿ hoáº¡ch: MÃ¡y B - ThÃ¡ng 6/2025
Plan Count: 4 (kiá»ƒm Ä‘á»‹nh 4 láº§n trong nÄƒm)
Khoáº£ng cho phÃ©p: 31/05/2025 â†’ 30/06/2025

Ká»‹ch báº£n:
- NgÃ y kiá»ƒm Ä‘á»‹nh: 25/05/2025 â†’ <span style="color: #f59e0b;">TRÆ¯á»šC Háº N</span>
- NgÃ y kiá»ƒm Ä‘á»‹nh: 15/06/2025 â†’ <span style="color: #10b981;">ÄÃšNG Káº¾ HOáº CH</span>
- NgÃ y kiá»ƒm Ä‘á»‹nh: 05/07/2025 â†’ <span style="color: #f97316;">SAU Háº N</span>
- KhÃ´ng cÃ³ record          â†’ <span style="color: #ef4444;">CHÆ¯A KIá»‚M Äá»ŠNH</span></code></pre>
        </div>

        <h2>âœ… VII. Äiá»ƒm quan trá»ng</h2>

        <div class="success-box">
            <ul>
                <li>âœ… <strong>Logic linh hoáº¡t:</strong> Khoáº£ng thá»i gian cho phÃ©p thay Ä‘á»•i tÃ¹y theo táº§n suáº¥t kiá»ƒm Ä‘á»‹nh (planCount)</li>
                <li>âœ… <strong>Match chÃ­nh xÃ¡c:</strong> Sá»­ dá»¥ng <code>mahieu = tenmay</code> vÃ  <code>namkh</code> Ä‘á»ƒ matching</li>
                <li>âœ… <strong>PhÃ¢n loáº¡i rÃµ rÃ ng:</strong> 4 tráº¡ng thÃ¡i dá»… hiá»ƒu, khÃ´ng overlap</li>
                <li>âœ… <strong>TÃ­nh tá»· lá»‡ hoÃ n thÃ nh:</strong> Bao gá»“m cáº£ trÆ°á»›c háº¡n vÃ  sau háº¡n (vÃ¬ Ä‘Ã£ thá»±c hiá»‡n)</li>
                <li>âœ… <strong>Há»— trá»£ export PDF:</strong> Biá»ƒu Ä‘á»“ trÃ²n + báº£ng chi tiáº¿t theo tá»«ng tráº¡ng thÃ¡i</li>
            </ul>
        </div>

        <h2>ğŸ”§ VIII. Code quan trá»ng</h2>

        <div class="section">
            <h3>calculateDateRange()</h3>
            <pre><code>if ($planCount == 1) {
    // 3 thÃ¡ng liÃªn tiáº¿p
    $startMonth = max(1, $thang - 2);
    $endMonth = $thang;
    $startDate = "{$namkh}-{$startMonth}-01";
    $endDate = last_day_of_month("{$namkh}-{$endMonth}-01");
} else {
    // Â±15 ngÃ y
    $midDate = "{$namkh}-{$thang}-15";
    $startDate = $midDate - 15 days;
    $endDate = $midDate + 15 days;
}</code></pre>

            <h3>classifyInspection()</h3>
            <pre><code>// TÃ¬m inspection record
$matchingInspection = find_where(
    tenmay = $mahieu AND namkh = $namkh
);

if (!$matchingInspection || !$matchingInspection['ngayhc']) {
    return 'chua_kiem_dinh';
}

$ngayhc = $matchingInspection['ngayhc'];

if ($ngayhc < $startDate) {
    return 'truoc_han';
} elseif ($ngayhc > $endDate) {
    return 'sau_han';
} else {
    return 'dung_ke_hoach';
}</code></pre>
        </div>

        <div class="info-box" style="margin-top: 30px;">
            <strong>ğŸ“„ TÃ i liá»‡u nÃ y mÃ´ táº£:</strong><br>
            Module: <code>controllers/ThongKeKiemDinhController.php</code><br>
            File: <code>thongke_kiemdinh.php</code><br>
            NgÃ y cáº­p nháº­t: 10/12/2025
        </div>
    </div>
</body>
</html>
